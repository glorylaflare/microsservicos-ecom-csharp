name: dotnet-ci

on:
  push:
    branches: [master, develop]
    paths:
      - '**/*.cs'
      - '**/*.csproj'
      - '**/*.sln'
      - '**/*.slnx'
      - Directory.Packages.props
      - docker-compose.yml
      - Dockerfile*
      - .github/workflows/**
  pull_request:
    branches: [master, develop]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: dotnet-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ecommerce: ${{ steps.filter.outputs.ecommerce }}
      order: ${{ steps.filter.outputs.order }}
      stock: ${{ steps.filter.outputs.stock }}
      user: ${{ steps.filter.outputs.user }}
      payment: ${{ steps.filter.outputs.payment }}
      shared: ${{ steps.filter.outputs.shared }}
      apigateway: ${{ steps.filter.outputs.apigateway }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shared:
              - Directory.Packages.props
              - docker-compose.yml
              - Dockerfile*
              - .github/workflows/**
              - '**/*.props'
            ecommerce:
              - Ecommerce.sln
              - ApiGateways/**
              - BuildingBlocks/**
            order:
              - Services/Order/**
            stock:
              - Services/Stock/**
            user:
              - Services/User/**
            apigateway:
              - ApiGateways/**
            payment:
              - Services/Payment/**

  dotnet:
    name: dotnet (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: changes
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ecommerce
            solution: Ecommerce.sln
            condition: ecommerce
          - name: order
            solution: Services/Order/Order.sln
            condition: order
          - name: stock
            solution: Services/Stock/Stock.sln
            condition: stock
          - name: user
            solution: Services/User/User.sln
            condition: user
          - name: payment
            solution: Services/Payment/Payment.slnx
            condition: payment
    steps:
      - uses: actions/checkout@v4
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true'

      - name: Setup .NET
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true'
        run: dotnet restore "${{ matrix.solution }}"

      - name: Build
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true'
        run: dotnet build "${{ matrix.solution }}" --configuration Release --no-restore

      - name: Test with coverage
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true'
        run: |
          dotnet test "${{ matrix.solution }}" --configuration Release --no-build \
            --logger "trx;LogFileName=${{ matrix.name }}-tests.trx" \
            --results-directory "TestResults/${{ matrix.name }}" \
            --collect "XPlat Code Coverage"

      - name: Upload test results
        if: |
          always() &&
          (github.event_name == 'workflow_dispatch' ||
          needs.changes.outputs.shared == 'true' ||
          needs.changes.outputs[matrix.condition] == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-test-results
          path: |
            TestResults/${{ matrix.name }}
            **/TestResults/${{ matrix.name }}-tests.trx

  apigateway-image:
    name: ApiGateway Container
    runs-on: ubuntu-latest
    needs:
      - changes
      - dotnet
    if: needs.changes.outputs.apigateway == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Build ApiGateway image
        run: >-
          docker build
          -f ApiGateways/Dockerfile
          -t ghcr.io/${{ github.repository }}/apigateway:${{ github.sha }}
          .

      - name: Login to GHCR
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push ApiGateway image
        if: github.ref == 'refs/heads/main'
        run: docker push ghcr.io/${{ github.repository }}/apigateway:${{ github.sha }}
